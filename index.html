<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirControl</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #020617; color: #e2e8f0; min-height: 100vh; }
        .glass-panel { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(99, 102, 241, 0.2); color: white; transition: all 0.3s; }
        .input-field:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none; }
        .font-mono { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const BASE_API = '';

        const useStickyState = (def, key) => {
            const [v, s] = useState(() => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } });
            useEffect(() => localStorage.setItem(key, JSON.stringify(v)), [key, v]);
            return [v, s];
        };

        // Icon an toàn (không crash)
        const Icon = ({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.className = className;
                    ref.current.appendChild(i);
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name]);
            return <span ref={ref} />;
        };

        const App = () => {
            const [config, setConfig] = useStickyState({ ghToken: '', repoName: 'air-vps', ngrokToken: '', rdpPassword: 'Admin@123' }, 'ac_conf');
            const [logs, setLogs] = useStickyState([], 'ac_logs');
            const [status, setStatus] = useStickyState('idle', 'ac_status');
            const [rdpLink, setRdpLink] = useStickyState(null, 'ac_link');
            const [timer, setTimer] = useState(0);
            const logsEndRef = useRef(null);

            useEffect(() => logsEndRef.current?.scrollIntoView({ behavior: "smooth" }), [logs]);

            useEffect(() => {
                let interval;
                if (status === 'running') {
                    interval = setInterval(() => {
                        setTimer(t => t + 1);
                        if (!rdpLink) checkLink();
                    }, 2000); // Check link mỗi 2s
                } else { setTimer(0); }
                return () => clearInterval(interval);
            }, [status, rdpLink]);

            const addLog = (msg, type = 'info') => {
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                const clean = msg.replace(/[✔⚠✖ℹ]/g, '').trim();
                setLogs(prev => [...prev, { time, msg: clean, type }]);
            };

            const checkLink = async () => {
                try {
                    const res = await fetch(`${BASE_API}/api/get-rdp-link`, {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(config)
                    });
                    const data = await res.json();
                    if (res.ok && data.rdpUrl) {
                        setRdpLink(data.rdpUrl);
                        setStatus('complete');
                        addLog(`⚡ KẾT NỐI THÀNH CÔNG: ${data.rdpUrl}`, 'success');
                    }
                } catch (e) {}
            };

            const handleDeploy = async () => {
                setLogs([]); setRdpLink(null); setStatus('initializing');
                addLog('KHỞI TẠO AIRCONTROL...', 'info');
                
                try {
                    const res = await fetch(`${BASE_API}/api/deploy`, {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(config)
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        data.logs.forEach(l => addLog(l.message, l.type));
                        setStatus('running');
                    } else {
                        addLog(`LỖI: ${data.message}`, 'error');
                        if(data.logs) data.logs.forEach(l => addLog(l.message, 'error'));
                        setStatus('idle');
                    }
                } catch (e) {
                    addLog('Lỗi kết nối Server!', 'error'); setStatus('idle');
                }
            };

            const handleStop = async () => {
                if(!confirm('Xóa toàn bộ?')) return;
                await fetch(`${BASE_API}/api/delete`, { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify(config) });
                addLog('✔ Đã xóa.', 'success'); setStatus('idle'); setRdpLink(null);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-4 space-y-6">
                            <div className="glass-panel rounded-2xl p-6">
                                <h1 className="text-2xl font-bold text-white mb-4 flex items-center gap-2"><Icon name="wind" className="text-indigo-400" /> AirControl</h1>
                                <div className="space-y-3">
                                    <input type="password" value={config.ghToken} onChange={e=>setConfig({...config, ghToken:e.target.value})} className="input-field w-full p-3 rounded-lg text-sm" placeholder="GitHub Token" />
                                    <input type="password" value={config.ngrokToken} onChange={e=>setConfig({...config, ngrokToken:e.target.value})} className="input-field w-full p-3 rounded-lg text-sm" placeholder="Ngrok Token" />
                                    <input type="text" value={config.repoName} onChange={e=>setConfig({...config, repoName:e.target.value})} className="input-field w-full p-3 rounded-lg text-sm" placeholder="Repo Name" />
                                    <input type="text" value={config.rdpPassword} onChange={e=>setConfig({...config, rdpPassword:e.target.value})} className="input-field w-full p-3 rounded-lg text-sm text-indigo-300" placeholder="Password" />
                                </div>
                                <div className="mt-6">
                                    {status === 'idle' ? 
                                        <button onClick={handleDeploy} className="w-full p-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg transition flex justify-center gap-2"><Icon name="rocket" /> TRIỂN KHAI</button> :
                                        <button onClick={handleStop} className="w-full p-3 bg-red-500/20 hover:bg-red-500/40 text-red-400 font-bold rounded-lg transition flex justify-center gap-2"><Icon name="trash" /> DỪNG & XÓA</button>
                                    }
                                </div>
                            </div>
                            <div className="glass-panel rounded-2xl p-4 flex justify-between text-white">
                                <span className="text-slate-400 text-sm">Time</span> <span className="font-mono font-bold">{timer}s</span>
                            </div>
                        </div>
                        <div className="lg:col-span-8 glass-panel rounded-2xl overflow-hidden flex flex-col h-[500px] relative">
                            <div className="p-4 bg-slate-900/50 border-b border-white/10 text-xs font-bold text-slate-400 uppercase">System Console</div>
                            <div className="flex-1 p-4 overflow-y-auto font-mono text-sm space-y-2 bg-[#0b1121]">
                                {logs.map((l, i) => <div key={i} className={`flex gap-2 ${l.type==='error'?'text-red-400':l.type==='success'?'text-emerald-400':'text-slate-300'}`}><span className="opacity-50">[{l.time}]</span><span>{l.msg}</span></div>)}
                                <div ref={logsEndRef}></div>
                            </div>
                            {rdpLink && <div className="absolute bottom-0 left-0 w-full bg-emerald-900/95 p-4 border-t border-emerald-500/50">
                                <h3 className="text-white font-bold text-sm mb-2 flex items-center gap-2"><Icon name="check" /> RDP READY</h3>
                                <div className="bg-black/40 p-3 rounded text-emerald-100 text-sm font-mono">
                                    IP: {rdpLink.replace('tcp://', '')}<br/>User: rdpuser<br/>Pass: {config.rdpPassword}
                                </div>
                            </div>}
                        </div>
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
