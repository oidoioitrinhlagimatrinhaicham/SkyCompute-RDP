<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyCompute RDP</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background: #020617; color: #e2e8f0; min-height: 100vh; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .input-field { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.1); color: white; transition: all 0.3s; }
        .input-field:focus { border-color: #6366f1; outline: none; }
        .font-mono { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const BASE_API = ''; // Tự động dùng domain hiện tại

        // Lưu trạng thái vào LocalStorage
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } catch { return defaultValue; }
            });
            useEffect(() => { localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
            return [value, setValue];
        };

        const Icon = ({ name }) => {
            useEffect(() => window.lucide?.createIcons(), []);
            return <i data-lucide={name}></i>;
        };

        const App = () => {
            const [config, setConfig] = useStickyState({ ghToken: '', repoName: 'rdp-vps', ngrokToken: '', rdpPassword: 'Admin@123' }, 'conf_v3');
            const [logs, setLogs] = useStickyState([], 'logs_v3');
            const [status, setStatus] = useStickyState('idle', 'status_v3'); 
            const [timer, setTimer] = useState(0);
            const [rdpLink, setRdpLink] = useStickyState(null, 'link_v3');
            const logsEndRef = useRef(null);

            useEffect(() => logsEndRef.current?.scrollIntoView({ behavior: "smooth" }), [logs]);

            useEffect(() => {
                let interval;
                if (['running', 'waiting', 'initializing'].includes(status)) {
                    interval = setInterval(() => {
                        setTimer(t => t + 1);
                        if (status === 'running' && !rdpLink) checkRdpLink();
                    }, 1000);
                } else { setTimer(0); }
                return () => clearInterval(interval);
            }, [status, rdpLink]);

            const addLog = (msg, type = 'info') => {
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                setLogs(prev => [...prev, { time, msg, type }]);
            };

            const callApi = async (ep, data) => {
                try {
                    const res = await fetch(`${BASE_API}${ep}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                    return { ok: res.ok, ...(await res.json()) };
                } catch (e) { return { ok: false, message: 'Lỗi kết nối!' }; }
            };

            const checkRdpLink = async () => {
                try {
                    const res = await fetch(`${BASE_API}/api/get-rdp-link`, {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(config)
                    });
                    const data = await res.json();
                    if (res.ok && data.rdpUrl) {
                        setRdpLink(data.rdpUrl);
                        addLog(`⚡ KẾT NỐI THÀNH CÔNG`, 'success');
                        setStatus('complete');
                    }
                } catch (e) {}
            };

            const handleDeploy = async () => {
                setLogs([]); setRdpLink(null); setStatus('initializing');
                addLog('--- KHỞI TẠO ---', 'info');
                const res = await callApi('/api/deploy', config);
                if (res.ok) {
                    res.logs.forEach(l => addLog(l.message, l.type));
                    setStatus('waiting');
                } else {
                    addLog(`Lỗi: ${res.message}`, 'error'); setStatus('idle');
                }
            };

            const handleConfirm = async () => {
                setStatus('running');
                addLog('Đang kích hoạt...', 'info');
                const res = await callApi('/api/dispatch', config);
                if (res.ok) {
                    addLog('✔ Đã gửi lệnh khởi động.', 'success');
                    addLog('⏳ Đang quét log để lấy IP (khoảng 1 phút)...', 'warning');
                } else {
                    addLog(`Lỗi: ${res.message}`, 'error'); setStatus('waiting');
                }
            };

            const handleStop = async () => {
                if (!confirm('Xóa toàn bộ?')) return;
                addLog('Đang xóa...', 'warning');
                await callApi('/api/delete', config);
                addLog('✔ Đã dọn dẹp.', 'success');
                setStatus('idle'); setRdpLink(null);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-4 space-y-6">
                            <div className="glass-panel rounded-3xl p-8">
                                <h1 className="text-2xl font-bold text-white mb-6">SkyCompute RDP</h1>
                                <div className="space-y-4">
                                    <input type="password" value={config.ghToken} onChange={e=>setConfig({...config, ghToken:e.target.value})} className="input-field w-full p-3 rounded-xl text-sm" placeholder="GitHub Token" disabled={status!=='idle'} />
                                    <input type="password" value={config.ngrokToken} onChange={e=>setConfig({...config, ngrokToken:e.target.value})} className="input-field w-full p-3 rounded-xl text-sm" placeholder="Ngrok Token" disabled={status!=='idle'} />
                                    <input type="text" value={config.repoName} onChange={e=>setConfig({...config, repoName:e.target.value})} className="input-field w-full p-3 rounded-xl text-sm" placeholder="Repo Name" disabled={status!=='idle'} />
                                    <input type="text" value={config.rdpPassword} onChange={e=>setConfig({...config, rdpPassword:e.target.value})} className="input-field w-full p-3 rounded-xl text-sm text-blue-400" placeholder="Password" disabled={status!=='idle'} />
                                </div>
                                <div className="mt-6 pt-6 border-t border-white/10">
                                    {status === 'idle' && <button onClick={handleDeploy} className="w-full p-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg transition-all">TRIỂN KHAI</button>}
                                    {status === 'waiting' && <div className="space-y-3"><div className="p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg text-amber-200 text-xs text-center">⚠ Thêm Secret <b>NGROK_TOKEN</b> trên GitHub rồi bấm dưới.</div><button onClick={handleConfirm} className="w-full p-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition-all">XÁC NHẬN & CHẠY</button><button onClick={handleStop} className="w-full py-2 text-slate-500 text-xs">Hủy bỏ</button></div>}
                                    {['running', 'complete'].includes(status) && <button onClick={handleStop} className="w-full p-4 bg-white/5 hover:bg-red-500/20 text-red-400 font-bold rounded-xl transition-all">DỪNG & XÓA</button>}
                                </div>
                            </div>
                            <div className="glass-panel rounded-2xl p-6 flex justify-between items-center">
                                <div className="flex items-center gap-3"><div className="p-2 bg-slate-800 rounded-lg text-slate-400"><Icon name="timer" size={18} /></div><span className="text-sm font-medium text-slate-400">Session Time</span></div><span className="text-2xl font-mono font-bold text-white">{formatTime(timer)}</span>
                            </div>
                        </div>
                        <div className="lg:col-span-8 glass-panel rounded-3xl overflow-hidden flex flex-col h-[600px] relative">
                            <div className="p-4 bg-slate-900/50 border-b border-white/10 flex justify-between"><span className="text-sm text-slate-400 font-mono">Console</span><span className="text-xs text-slate-500">{timer}s</span></div>
                            <div className="flex-1 p-6 overflow-y-auto font-mono text-sm space-y-2 bg-[#0b1121]">
                                {logs.map((l, i) => <div key={i} className={`flex gap-3 ${l.type==='error'?'text-red-400':l.type==='success'?'text-emerald-400':'text-slate-300'}`}><span className="opacity-50">[{l.time}]</span><span>{l.msg}</span></div>)}
                                <div ref={logsEndRef}></div>
                            </div>
                            {rdpLink && <div className="absolute bottom-0 left-0 w-full bg-emerald-900/95 p-6 animate-slide-up border-t border-emerald-500/50">
                                <h3 className="text-white font-bold mb-2">✅ RDP READY</h3>
                                <div className="bg-black/40 p-4 rounded-lg font-mono text-sm text-emerald-100 space-y-1">
                                    <p>ADDRESS: <span className="text-white font-bold">{rdpLink.replace('tcp://', '')}</span></p>
                                    <p>USER: rdpuser</p>
                                    <p>PASS: {config.rdpPassword}</p>
                                </div>
                            </div>}
                        </div>
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
